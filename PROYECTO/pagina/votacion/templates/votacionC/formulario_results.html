{% extends "votacionC/base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="{% url 'votacion:formulario_list' %}" class="btn btn-link text-decoration-none ps-0">
      &larr; Regresar a mis formularios
    </a>
    <h2>Resultados: <span class="text-muted">{{ formulario.titulo }}</span></h2>
    <p>Total de envíos: {{ formulario.envios.count }}</p>
  </div>
</div>

<hr>

{% for result in results_data %}
  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h4 class="mb-0">{{ forloop.counter }}. {{ result.question.pregunta_texto }}</h4>
      <span class="badge 
        {% if result.type == 'CHOICE' %}bg-primary{% else %}bg-info{% endif %}">
        {{ result.question.get_tipo_pregunta_display }}
      </span>
    </div>
    
    <div class="card-body">
      {% if result.type == 'CHOICE' %}
        <p class="text-muted">Total de votos para esta pregunta: {{ result.total_votes }}</p>
        <div style="max-height: 400px;">
          <canvas id="chart_{{ result.question.pk }}"></canvas>
        </div>
        
      {% elif result.type == 'TEXT' %}
        {% if result.text_responses %}
          <ul class="list-group list-group-flush">
            {% for text in result.text_responses %}
              {% if text %} <li class="list-group-item">{{ text }}</li>
              {% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No hay respuestas de texto para esta pregunta.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ¡Bucle de JavaScript generado por Django!
  // Esto crea una gráfica por cada pregunta de opción múltiple
  {% for result in results_data %}
    {% if result.type == 'CHOICE' %}
      
      // Obtenemos el canvas de esta iteración
      const ctx_{{ result.question.pk }} = document.getElementById('chart_{{ result.question.pk }}');
      
      // Creamos la gráfica
      new Chart(ctx_{{ result.question.pk }}, {
        type: 'doughnut',
        data: {
          labels: {{ result.labels|safe }}, // |safe es vital aquí
          datasets: [{
            label: 'Votos',
            data: {{ result.data|safe }}, // |safe es vital aquí
            backgroundColor: [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
      
    {% endif %}
  {% endfor %}
</script>

{% endblock %}